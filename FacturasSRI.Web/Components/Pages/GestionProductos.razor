@page "/gestion-productos"
@inject HttpClient Http
@inject NavigationManager Navigation

@rendermode InteractiveServer
@using FacturasSRI.Application.Dtos.Productos

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Gesti贸n de Productos</h3>
    <button class="btn btn-primary" @onclick="GoToCreatePage">
        <span class="bi bi-plus-circle-fill me-2" aria-hidden="true"></span> Crear Nuevo Producto
    </button>
</div>

<div class="input-group mb-3">
    <span class="input-group-text">
        <span class="bi bi-search"></span>
    </span>
    <input type="text" class="form-control" placeholder="Buscar por c贸digo o nombre..." 
           @bind="searchQuery" @bind:event="oninput" />
</div>

@if (editingId.HasValue && productoModel != null)
{
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            Editando Producto
        </div>
        <div class="card-body">
            <EditForm Model="@productoModel" OnValidSubmit="HandleUpdate" FormName="edit-product-form">
                <DataAnnotationsValidator />
                <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <InputText class="form-control" @bind-Value="productoModel.Nombre" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Descripci贸n</label>
                    <InputTextArea class="form-control" @bind-Value="productoModel.Descripcion" />
                </div>
                 <div class="mb-3">
                    <label class="form-label">Precio de Venta</label>
                    <InputNumber class="form-control" @bind-Value="productoModel.PrecioVentaUnitario" />
                </div>
                <button type="submit" class="btn btn-primary">Actualizar</button>
                <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancelar</button>
            </EditForm>
        </div>
    </div>
}

@if (productos == null)
{
    <p><em>Cargando productos...</em></p>
}
else
{
    <table class="table table-striped table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>C贸digo</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var producto in FilteredProducts)
            {
                <tr>
                    <td>@producto.CodigoPrincipal</td>
                    <td>@producto.Nombre</td>
                    <td>@producto.PrecioVentaUnitario.ToString("C")</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" @onclick="() => StartEdit(producto)">Editar</button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Deactivate(producto.Id)">Desactivar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<ProductoDto>? productos;
    private string searchQuery = string.Empty;
    private Guid? editingId;
    private UpdateProductoDto? productoModel;

    private IEnumerable<ProductoDto> FilteredProducts =>
        productos?.Where(p =>
            string.IsNullOrWhiteSpace(searchQuery) ||
            p.CodigoPrincipal.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            p.Nombre.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
        ) ?? Enumerable.Empty<ProductoDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        productos = await Http.GetFromJsonAsync<List<ProductoDto>>("api/productos");
    }

    private void StartEdit(ProductoDto producto) 
    {
        editingId = producto.Id;
        productoModel = new UpdateProductoDto 
        { 
            Nombre = producto.Nombre, 
            Descripcion = producto.Descripcion, 
            PrecioVentaUnitario = producto.PrecioVentaUnitario 
        };
    }
    
    private async Task HandleUpdate()
    {
        if (editingId.HasValue && productoModel != null)
        {
            await Http.PutAsJsonAsync($"api/productos/{editingId.Value}", productoModel);
            CancelEdit();
            await LoadProducts();
        }
    }
    
    private void CancelEdit()
    {
        editingId = null;
        productoModel = null;
    }
    
    private async Task Deactivate(Guid id)
    {
        await Http.PatchAsync($"api/productos/{id}/deactivate", null);
        await LoadProducts();
    }

    private void GoToCreatePage()
    {
        Navigation.NavigateTo("/gestion-productos/crear");
    }
}