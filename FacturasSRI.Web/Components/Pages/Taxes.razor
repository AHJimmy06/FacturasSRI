@page "/taxes"
@attribute [Authorize]
@using FacturasSRI.Application.Dtos
@using FacturasSRI.Application.Interfaces
@inject ITaxService TaxService

<PageTitle>Impuestos</PageTitle>

<h1>Impuestos</h1>

<div class="mb-3">
    <EditForm Model="@newTax" OnValidSubmit="@HandleAddTax">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="nombre" class="form-label">Nombre</label>
                    <InputText id="nombre" class="form-control" @bind-Value="newTax.Nombre" />
                    <ValidationMessage For="@(() => newTax.Nombre)" />
                </div>
                <div class="mb-3">
                    <label for="codigoSRI" class="form-label">Código SRI</label>
                    <InputText id="codigoSRI" class="form-control" @bind-Value="newTax.CodigoSRI" />
                    <ValidationMessage For="@(() => newTax.CodigoSRI)" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="porcentaje" class="form-label">Porcentaje</label>
                    <InputNumber id="porcentaje" class="form-control" @bind-Value="newTax.Porcentaje" />
                    <ValidationMessage For="@(() => newTax.Porcentaje)" />
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Añadir Impuesto</button>
    </EditForm>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Código SRI</th>
            <th>Porcentaje</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var tax in taxes)
        {
            <tr>
                <td>@tax.Nombre</td>
                <td>@tax.CodigoSRI</td>
                <td>@tax.Porcentaje</td>
                <td>
                    <button class="btn btn-sm btn-danger" @onclick="() => HandleDeleteTax(tax.Id)">Desactivar</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private List<TaxDto> taxes = new();
    private TaxDto newTax = new();

    protected override async Task OnInitializedAsync()
    {
        taxes = await TaxService.GetTaxesAsync();
    }

    private async Task HandleAddTax()
    {
        await TaxService.CreateTaxAsync(newTax);
        newTax = new();
        taxes = await TaxService.GetTaxesAsync();
    }

    private async Task HandleDeleteTax(Guid id)
    {
        await TaxService.DeleteTaxAsync(id);
        taxes = await TaxService.GetTaxesAsync();
    }
}