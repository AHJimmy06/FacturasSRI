# Plan de Acción v2: Gestión de Compras (Refactorización y Mejoras)

## Resumen del Objetivo
Refactorizar y ampliar el módulo de compras para mejorar la usabilidad y añadir funcionalidades clave de auditoría y filtrado, basándose en el feedback del usuario.

---

### Fase A: Corregir Flujo de Pago (Simplificación)

**Objetivo:** Eliminar la entrada manual de la fecha de pago para que se asigne automáticamente al confirmar el pago.

1.  **UI (`RegisterPayment.razor`):** Eliminar el campo `<InputDate>` para `FechaPago`. La página solo solicitará el comprobante de pago.
2.  **DTO (`RegisterPaymentDto.cs`):** Eliminar la propiedad `FechaPago`.
3.  **Servicio (`IPurchaseService` y `PurchaseService`):**
    *   Actualizar la firma del método `RegisterPaymentAsync` para que ya no reciba la fecha.
    *   En la implementación, al procesar un pago, asignar `purchase.FechaPago = DateTime.UtcNow;` automáticamente.

---

### Fase B: Mejorar Vista de Lista de Compras (Filtros y Columnas)

**Objetivo:** Enriquecer la lista de `CuentasPorPagar` con filtros avanzados y columnas más informativas.

1.  **Añadir Columna `FechaVencimiento`:** Modificar la tabla en `ListPurchases.razor` para incluir esta columna. Se mostrará "N/A" para las compras que no son a crédito.
2.  **Implementar Filtros Avanzados:**
    *   Añadir un control de tipo `<select>` (dropdown) en `ListPurchases.razor` para filtrar por `EstadoCompra`.
    *   Establecer el filtro por defecto a `EstadoCompra.Pendiente` cuando se carga la página.
    *   Opcional: Añadir un filtro por rango de fechas.
3.  **Actualizar Lógica de Filtrado:** Modificar la propiedad `FilteredPurchases` para que aplique los filtros seleccionados (estado, búsqueda por texto, etc.) a la lista.

---

### Fase C: Implementar Vista de Detalles de Compra

**Objetivo:** Crear una vista de solo lectura que muestre toda la información de una compra, incluyendo campos de auditoría y los comprobantes.

1.  **Añadir Botón "Ver Detalles":** En cada fila de la tabla de `ListPurchases.razor`, añadir este nuevo botón.
2.  **Crear Componente `PurchaseDetails.razor`:**
    *   Crear una nueva página en la ruta `/purchases/details/{PurchaseId}`.
    *   La página llamará a `PurchaseService.GetPurchaseByIdAsync(PurchaseId)` para obtener los datos.
3.  **Mostrar Todos los Campos:** Renderizar todos los campos relevantes del DTO `PurchaseListItemDto`, como `FechaCreacion`, `Estado`, `MontoTotal`, `FechaPago`, `FechaVencimiento`, etc., en un formato claro y de solo lectura.
4.  **Visualización de Comprobantes:**
    *   Añadir un botón **"Ver Factura de Compra"**, que enlazará a la descarga de `FacturaCompraPath`.
    *   Añadir un botón **"Ver Comprobante de Pago"**, que solo será visible si `ComprobantePagoPath` no es nulo y enlazará a su descarga.
5.  **Refactorizar Endpoint de Descarga:**
    *   Modificar el `DownloadEndpoints.cs` para que pueda servir ambos tipos de archivos. Se puede añadir un parámetro a la ruta, por ejemplo: `/api/downloads/purchase-receipt/{id}?type=invoice` y `.../?type=payment`.
    *   El endpoint leerá el parámetro `type` y devolverá el archivo del campo `FacturaCompraPath` o `ComprobantePagoPath` según corresponda.

---

### Fase D: Manejo de Vencimientos (Tarea Programada - Antigua Fase 6)

**Objetivo:** Automatizar la transición de estado de `Pendiente` a `Vencida`.

1.  **Lógica de Negocio:** La única acción automática será cambiar el estado. La decisión sobre qué hacer con la compra (cancelar, etc.) queda como una acción manual del usuario.
2.  **Implementación:**
    *   Crear un "hosted service" (trabajo en segundo plano) en .NET.
    *   Este servicio se ejecutará una vez al día.
    *   Buscará todas las `CuentasPorPagar` con estado `Pendiente` donde `FechaVencimiento` sea anterior a la fecha actual.
    *   Para cada una, actualizará su `Estado` a `Vencida`.
