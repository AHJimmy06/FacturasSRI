# Plan de Acción Refactorizado v2: Gestión Avanzada de Compras

## Resumen del Objetivo
Implementar una gestión completa para el registro y seguimiento de compras, distinguiendo entre compras pagadas y a crédito. Se usará un sistema de estados explícito, se simplificará el modelo de datos y se implementará un flujo de pago completo.

---

### Fase 1: (REFACTOR) Modelo de Datos y Migración

**Objetivo:** Ajustar la entidad `CuentaPorPagar` para que refleje la nueva lógica simplificada.

1.  **Crear Enum `EstadoCompra`:**
    *   Crear un nuevo archivo enum `EstadoCompra.cs` en el proyecto `FacturasSRI.Domain`.
    *   El enum contendrá los valores: `Pendiente`, `Pagada`, `Vencida`, `Cancelada`.
2.  **Modificar Entidad `CuentaPorPagar`:**
    *   **Eliminar** el campo `bool Pagada`.
    *   **Eliminar** el campo `decimal SaldoPendiente`.
    *   **Añadir** un nuevo campo `EstadoCompra Estado { get; set; }`.
    *   **Añadir** un nuevo campo nulable `DateTime? FechaPago { get; set; }`.
3.  **Generar y Aplicar Migración:**
    *   Crear una nueva migración de base de datos para aplicar estos cambios en el esquema.

---

### Fase 2: Modificación de la UI para el Registro de Compras

**Objetivo:** Actualizar el formulario de creación de compras para que se alinee con el nuevo modelo.

1.  **Analizar la Vista de Creación:** Revisar la página/componente `.razor` actual para registrar compras.
2.  **Añadir Opción "Es Compra a Crédito":**
    *   Incorporar un control único, como un **checkbox** llamado "Es compra a crédito".
3.  **Lógica de Formulario Dinámico:**
    *   **Si el checkbox NO está marcado (compra al contado):**
        *   El sistema asumirá que el estado es `Pagada`.
        *   El campo `FechaVencimiento` se ocultará. La `FechaPago` se asignará internamente a la fecha actual.
    *   **Si el checkbox SÍ está marcado (compra a crédito):**
        *   El sistema asignará el estado `Pendiente`.
        *   El campo `FechaVencimiento` será visible y obligatorio.
4.  **Campo `MontoTotal`:**
    *   La etiqueta de este campo se actualizará a: **"Monto Total de la Factura (IVA incluido)"** para mayor claridad.
5.  **Actualizar el DTO:** Modificar el DTO de creación de compra para que envíe la información necesaria (ej. el booleano `EsCredito` y la `FechaVencimiento` si aplica).

---

### Fase 3: Ajustes en el Backend (Lógica de Creación)

**Objetivo:** Adaptar el servicio que crea la `CuentaPorPagar`.

1.  **Modificar `PurchaseService.CreatePurchaseAsync`:**
    *   El servicio recibirá el DTO actualizado.
    *   Asignará el `Estado` a `Pagada` o `Pendiente` según el valor del checkbox.
    *   Si el estado es `Pagada`, asignará `FechaPago = DateTime.UtcNow`.
    *   Guardará la `FechaVencimiento` solo si es una compra a crédito.
2.  **Validaciones en el Backend:**
    *   Asegurar que si es a crédito, `FechaVencimiento` sea una fecha futura.
    *   `MontoTotal` debe ser un valor mayor a cero.

---

### Fase 4: Visualización Mejorada en la Lista de Compras

**Objetivo:** Mejorar la tabla que lista las `CuentasPorPagar`.

1.  **Añadir y Modificar Columnas:**
    *   Añadir una columna **`Estado`**.
    *   Añadir una columna para `Fecha de Pago`.
    *   Usar "badges" de colores para el estado:
        *   `Pagada`: Verde
        *   `Pendiente`: Amarillo
        *   `Vencida`: Rojo
        *   `Cancelada`: Gris
2.  **Botón de Acción "Registrar Pago":**
    *   Añadir un botón que solo será visible para las compras con estado `Pendiente` o `Vencida`.

---

### Fase 5: Implementación del Flujo de Pago (Simplificado)

**Objetivo:** Crear la funcionalidad para saldar una `CuentaPorPagar`.

1.  **Crear Vista/Modal de Pago:**
    *   Al hacer clic en "Registrar Pago", se abrirá un formulario.
    *   El formulario mostrará el `MontoTotal` a pagar (solo lectura).
    *   Solicitará una **`Fecha de Pago`** (por defecto la fecha actual) y un **comprobante de pago** (adjunto obligatorio).
2.  **Lógica de Negocio (`PurchaseService.RegisterPaymentAsync`):**
    *   El método recibirá el `Id` de la cuenta, la `FechaPago` y el archivo del comprobante.
    *   Cambiará el `Estado` de la compra a `Pagada`.
    *   Asignará la `FechaPago` proporcionada.
    *   Guardará la ruta del nuevo comprobante de pago.

---

### Fase 6: Manejo de Vencimientos (Tarea Programada)

**Objetivo:** Automatizar la transición de estado de `Pendiente` a `Vencida`.

1.  **Lógica de Negocio:** La única acción automática será cambiar el estado. La decisión sobre qué hacer con la compra (cancelar, etc.) queda como una acción manual del usuario.
2.  **Implementación:**
    *   Crear un "hosted service" (trabajo en segundo plano) en .NET.
    *   Este servicio se ejecutará una vez al día.
    *   Buscará todas las `CuentasPorPagar` con estado `Pendiente` donde `FechaVencimiento` sea anterior a la fecha actual.
    *   Para cada una, actualizará su `Estado` a `Vencida`.
