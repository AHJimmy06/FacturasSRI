Este es un resumen del plan de acción que hemos ejecutado para mejorar el sistema de facturación:

**Fase 1: Implementar la Creación de Borradores**

1.  **DTO y Lógica de Creación:**
    *   Localizaré y modificaré el DTO (`CreateCreditNoteDto`) que se usa para crear notas de crédito, añadiéndole la bandera `EsBorrador`.
    *   Adaptaré el método `CreateCreditNoteAsync` en el servicio (`CreditNoteService.cs`). Si `EsBorrador` es `true`, se creará la nota de crédito con estado `Borrador` y, muy importante, **se saltará la lógica de restaurar el inventario y de enviar la nota al SRI**.

2.  **Interfaz de Usuario (UI) para la Creación:**
    *   Investigaré desde qué parte de la aplicación se crean las notas de crédito (probablemente desde la página de detalles de una factura).
    *   Añadiré una casilla de "Guardar como Borrador" en esa interfaz.

**Fase 2: Gestión de Borradores y Cancelados**

3.  **Página de Listado (`ListCreditNotes.razor`):**
    *   Añadiré una insignia de color (ej. amarillo) para el estado `Borrador`.
    *   Para las notas de crédito en estado `Borrador`, añadiré los botones de **"Editar"** y **"Cancelar"**.
    *   Implementaré un **modal de confirmación** para la acción de cancelar.
    *   Para las notas en estado `Cancelada`, añadiré un botón de **"Reactivar"** que solo será visible para los usuarios **Administradores**.

4.  **Nuevos Métodos en el Servicio:**
    *   Crearé `CancelCreditNoteAsync` para cambiar el estado de `Borrador` a `Cancelada`.
    *   Crearé `ReactivateCancelledCreditNoteAsync` para que los administradores puedan revertir una cancelación.

**Fase 3: Edición y Emisión Final de Borradores**

5.  **Página de Detalles (`CreditNoteDetail.razor`):**
    *   Si una nota de crédito es un `Borrador`, se mostrará un botón principal para **"Emitir Nota de Crédito"**, que la enviará al SRI.
    *   También se incluirá aquí el botón de "Reactivar" para administradores si está cancelada.

6.  **Implementación de la Edición:**
    *   Crearé los DTOs y métodos de servicio necesarios (`UpdateCreditNoteDto`, `UpdateCreditNoteAsync`) para guardar los cambios de un borrador. La lógica se asegurará de no tocar el inventario durante la edición.
    *   Crearé una **página de edición** (ej. `EditCreditNote.razor`) que cargará los datos del borrador en un formulario, similar a como lo hicimos con las facturas.
    *   Esta página tendrá los botones **"Guardar Cambios"** y **"Guardar y Emitir"**.

7.  **Lógica de Emisión (`IssueDraftCreditNoteAsync`):**
    *   Este será el método crucial que se llamará al "Emitir" un borrador.
    *   Su responsabilidad será ejecutar toda la lógica que se omitió al crearlo: **restaurar el stock**, actualizar las cantidades devueltas en la factura original y enviar la nota de crédito al SRI.